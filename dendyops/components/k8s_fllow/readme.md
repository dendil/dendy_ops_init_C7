# 配置cobbler
```bash


10.4.7.11	00:0c:29:1f:88:c7 amd7-11.host.com
10.4.7.12	00:0c:29:f2:b7:32 amd7-12.host.com
10.4.7.21	00:0c:29:86:d0:f1 amd7-21.host.com
10.4.7.22	00:0c:29:91:dd:d1 amd7-22.host.com
10.4.7.200	00:0c:29:2f:d6:e4 amd7-200.host.com



```

# use amd7-200
```
#add dendyops
cd /tmp && git clone https://github.com/dendil/dendy_ops_init_C7.git &&cd dendy_ops_init_C7 &&find . -name '*.sh' -exec chmod u+x {} \; &&bash init.sh update
# dhcp  to static
/opt/dendyops/components/utils/config_static_eth0.sh 
/opt/dendyops/components/utils/make_hosts.sh /opt/dendyops/components/k8s_fllow/hosts.txt
mv /etc/hosts{,.bak.$RANDOM} 
cp /opt/hosts /etc/
# 设置主机名
/opt/dendyops/components/utils/set_hostname.sh
# 生成密钥
/opt/dendyops/components/ssh/ssh_key_gen.sh
# 分发密钥
/opt/dendyops/components/ssh/fenfa_clinet_ssk.sh ~/.ssh/id_rsa.pub 123456 /opt/dendyops/components/k8s_fllow/hosts.txt

/opt/dendyops/components/ssh/fenfa_clinet_ssk_test.sh /opt/dendyops/components/k8s_fllow/hosts.txt hostname
#初始化子节点
/opt/dendyops/components/ssh/fenfa_client_file.sh    /opt/dendyops/components/k8s_fllow/hosts.txt /tmp/dendy_ops_init_C7 /tmp/
/opt/dendyops/components/ssh/fenfa_clinet_ssk_test.sh  /opt/dendyops/components/k8s_fllow/hosts.txt 'bash /tmp/dendy_ops_init_C7/init.sh update'
/opt/dendyops/components/ssh/fenfa_client_file.sh   /opt/dendyops/components/k8s_fllow/hosts.txt /opt/hosts  /etc/hosts
/opt/dendyops/components/ssh/fenfa_clinet_ssk_test.sh  /opt/dendyops/components/k8s_fllow/hosts.txt 'bash /opt/dendyops/components/utils/set_hostname.sh'
#安装saltstack salt-ssh
/opt/dendyops/components/saltstack/install_salt_master.sh  
# 生成 roster
/opt/dendyops/components/salt_k8s/ip_2_roster.sh /opt/dendyops/components/k8s_fllow/hosts.txt
mv /etc/salt/roster{,.bak}
 cp /opt/roster  /etc/salt/
```
use amd7-11
# 安装 bind
```
yum install -y bind



 vim /etc/named.conf  # 确保以下配置正确

  listen-on port 53 { 10.4.7.11; }; # 监听端口53 下面一行本来有ipv6地址 需要删除
  directory   "/var/named";
  allow-query     { any; }; #允许内机器都可以查
  forwarders      { 10.4.7.254; };　# 上级dns 虚拟机这里填的是网关地址，阿里云机器可以填223.5.5.5
  recursion yes; # 采用递归方法查询IP
  dnssec-enable no;
  dnssec-validation no;

named-checkconf # 检查配置  没有信息即为正确


# 增加两个zone配置，od.com为业务域，host.com.zone为主机域
 vim /etc/named.rfc1912.zones  

zone "host.com" IN {
        type  master;
        file  "host.com.zone";
        allow-update { 10.4.7.11; };
};

zone "od.com" IN {
        type  master;
        file  "od.com.zone";
        allow-update { 10.4.7.11; };
};
# line6中时间需要修改 格式为xxxx xx xx01（年月日01）每次修改配置文件都需要前滚一个序列号
vim /var/named/host.com.zone
$ORIGIN host.com.
$TTL 600  ; 10 minutes # 过期时间十分钟 这里的分号是注释
@       IN SOA  dns.host.com. dnsadmin.host.com. (
        20210416 ; serial
        10800      ; refresh (3 hours) # soa参数
        900        ; retry (15 minutes)
        604800     ; expire (1 week)
        86400      ; minimum (1 day)
        )
      NS   dns.host.com.
$TTL 60 ; 1 minute
dns                A    10.4.7.11
amd7-11           A    10.4.7.11
amd7-12           A    10.4.7.12
amd7-21           A    10.4.7.21
amd7-22           A    10.4.7.22
amd7-200          A    10.4.7.200
 vim /var/named/od.com.zone
$ORIGIN od.com.
$TTL 600  ; 10 minutes
@       IN SOA  dns.od.com. dnsadmin.od.com. (
        2020010501 ; serial
        10800      ; refresh (3 hours)
        900        ; retry (15 minutes)
        604800     ; expire (1 week)
        86400      ; minimum (1 day)
        )
        NS   dns.od.com.
$TTL 60 ; 1 minute
dns                A    10.4.7.11
amd7-11           A    10.4.7.11
amd7-12           A    10.4.7.12
amd7-21           A    10.4.7.21
amd7-22           A    10.4.7.22
amd7-200          A    10.4.7.200
harbor          A    10.4.7.200


systemctl  start named &&  systemctl  enable  named
cat /etc/sysconfig/network-scripts/ifcfg-eth0 

DEVICE=eth0
BOOTPROTO=dhcp
ONBOOT=yes
DNS1=10.4.7.11

salt-ssh  '*' cmd.run 'sed -i "1 a search\ host.com"  /etc/resolv.conf '
 systemctl restart network
 cat /etc/resolv.conf
# Generated by NetworkManager
search host.com #添加后解析主机A记录 可以不加域名 例如 dig -t A hdss7-11  @10.4.7.11 +short
nameserver 10.4.7.11


 
 
 wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O /usr/local/bin/cfssl
 wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O /usr/local/bin/cfssl-json
 wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O /usr/local/bin/cfssl-certinfo
 chmod u+x /usr/local/bin/cfssl*
``` 
# 在 amd7-200 签发根证书 
证书签发服务器 amd7-200:
• 创建ca的json配置: /opt/certs/ca-config.json
• server 表示服务端连接客户端时携带的证书，用于客户端验证服务端身份
• client 表示客户端连接服务端时携带的证书，用于服务端验证客户端身份
• peer 表示相互之间连接时使用的证书，如etcd节点之间验证
 "expiry": "175200h" 证书有效期 十年  如果这里是一年的话 到期后集群会立宕掉
```
mkdir /opt/certs/ ; cd /opt/certs/
vim /opt/certs/ca-csr.json
{
    "CN": "kubenets",
    "hosts": [
    ],
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "C": "CN",
            "ST": "guangdong",
            "L": "guangdong",
            "O": "od",
            "OU": "ops"
        }
    ],
    "ca": {
        "expiry": "175200h"
    }
}

cfssl gencert -initca ca-csr.json | cfssl-json -bare ca

```

# 安装 docker
amd7-21 amd7-22 amd7-200
```
/opt/dendyops/components/docker/install_docker_ce.sh
ssh amd7-21 /opt/dendyops/components/docker/install_docker_ce.sh
ssh amd7-22 /opt/dendyops/components/docker/install_docker_ce.sh
mkdir -p /data/docker
ssh amd7-21 'mkdir -p /data/docker'
ssh amd7-22 'mkdir -p /data/docker'
cat >/etc/docker/daemon.json<<eof
{
  "graph": "/data/docker",
  "storage-driver": "overlay2",
  "insecure-registries": ["registry.access.redhat.com","quay.io","harbor.od.com"],
  "registry-mirrors": ["https://registry.docker-cn.com"],
  "bip": "172.7.21.1/24",
  "exec-opts": ["native.cgroupdriver=systemd"],
  "live-restore": true
}
eof

scp /etc/docker/daemon.json amd7-21:/etc/docker/daemon.json
sed -i 's#172.7.21.1/24#172.7.22.1/24#g' /etc/docker/daemon.json
scp /etc/docker/daemon.json amd7-22:/etc/docker/daemon.json
sed -i 's#172.7.22.1/24#172.7.200.1/24#g' /etc/docker/daemon.json
systemctl  restart docker
ssh amd7-21 'systemctl  restart docker'
ssh amd7-22 'systemctl  restart docker'


“registry-mirrors”: [“https://tmlnvmvx.mirror.aliyuncs.com”]

```
# harbor
amd7-200
```
#harbor需要docker-compose
/opt/dendyops/components/docker-compose/install_docker_compose.sh 
/opt/dendyops/components/harbor/install_harbor_in_k8s.sh 1.8 3 180
/opt/dendyops/components/harbor/install_harbor_in_k8s.sh 1.8 3 180 harbor.od.com harbor.od.com
# 反代 harbor 
yum install -y nginx
cat > /etc/nginx/conf.d/harbor.conf <<eof
server {
    listen       80;
    server_name  harbor.od.com;
    # 避免出现上传失败的情况
    client_max_body_size 1000m;

    location / {
        proxy_pass http://127.0.0.1:180;
    }
}
eof
systemctl start nginx ; systemctl enable nginx
# http://harbor.od.com  admin/harbor.od.com
docker pull nginx:1.7.9
docker tag nginx:1.7.9  harbor.od.com/public/nginx:v1.7.9
docker login -u admin harbor.od.com
docker push harbor.od.com/public/nginx:v1.7.9
docker logout 


```

etcd
amd7-12 amd7-21 amd7-22
```

cat >/opt/certs/ca-config.json<<eof
{
    "signing": {
        "default": {
            "expiry": "175200h"
        },
        "profiles": {
            "server": {
                "expiry": "175200h",
                "usages": [
                    "signing",
                    "key encipherment",
                    "server auth"
                ]
            },
            "client": {
                "expiry": "175200h",
                "usages": [
                    "signing",
                    "key encipherment",
                    "client auth"
                ]
            },
            "peer": {
                "expiry": "175200h",
                "usages": [
                    "signing",
                    "key encipherment",
                    "server auth",
                    "client auth"
                ]
            }
        }
    }
}
eof
#
cat >/opt/certs/etcd-peer-csr.json<<eof
{
    "CN": "k8s-etcd",
    "hosts": [
        "10.4.7.11",
        "10.4.7.12",
        "10.4.7.21",
        "10.4.7.22"
    ],
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "C": "CN",
            "ST": "guangdong",
            "L": "guangdong",
            "O": "od",
            "OU": "ops"
        }
    ]
}
eof
cd /opt/certs/

cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer etcd-peer-csr.json |cfssl-json -bare etcd-peer
cd /opt/src/
useradd -s /sbin/nologin -M etcd
wget https://github.com/coreos/etcd/releases/download/v3.1.8/etcd-v3.1.8-linux-amd64.tar.gz
salt-ssh -L 'amd7-12.host.com,amd7-21.host.com,amd7-22.host.com' cmd.run 'mkdir -p /opt/etcd/certs/'
salt-ssh -L 'amd7-12.host.com,amd7-21.host.com,amd7-22.host.com' cmd.run 'mkdir -p /opt/src'
salt-ssh -L 'amd7-12.host.com,amd7-21.host.com,amd7-22.host.com' cp.get_file  /opt/src/etcd-v3.1.8-linux-amd64.tar.gz /opt/src/etcd-v3.1.8-linux-amd64.tar.gz

salt-ssh -L 'amd7-12.host.com,amd7-21.host.com,amd7-22.host.com' cmd.run 'useradd -s /sbin/nologin -M etcd'
salt-ssh -L 'amd7-12.host.com,amd7-21.host.com,amd7-22.host.com' cmd.run  'mkdir -p /opt/etcd/certs /data/etcd /data/logs/etcd-server'

/opt/dendyops/components/ssh/fenfa_client_file.sh   /opt/dendyops/components/k8s_fllow/hosts.txt /opt/certs /opt/etcd/certs





```
